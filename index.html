<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Mini Wikipedia</title>
<link rel="stylesheet" href="style.css">
</head>

<body>

<h1>Mini Wikipedia</h1>

<p>
Questo √® un <a class="wiki-link" href="termine1.html" data-preview="termine1">termine speciale</a> con preview.
</p>

<div id="termine1" class="wiki-preview">
  <h4>Termine speciale</h4>
  <img src="img/termine1.jpg" alt="Termine speciale">
  <p>Testo di esempio che verr√† sostituito automaticamente dal JS.</p>
</div>

<hr>

<h2>Editor live</h2>
<p>Scrivi qui e vedi l‚Äôanteprima immediata:</p>

<textarea id="editor" rows="10" cols="80">Scrivi qui il tuo testo...</textarea>
<div id="preview" style="border:1px solid #ccc; padding:10px; margin-top:10px;"></div>
  
<button id="saveBtn">üíæ Salva su GitHub</button>
<p id="saveStatus"></p>
<script>
// ---------------------- HOVER PREVIEW ----------------------
document.querySelectorAll('.wiki-link').forEach(link => {
  const preview = document.getElementById(link.dataset.preview);

  // Carica testo della pagina collegata
  const url = link.getAttribute('href');
  fetch(url)
    .then(resp => resp.text())
    .then(html => {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const firstParagraph = doc.querySelector('p');
      if(firstParagraph) {
        preview.querySelector('p').innerText = firstParagraph.innerText;
      }
    });

  function updatePosition(e) {
    const rect = preview.getBoundingClientRect();
    let x = e.pageX + 15;
    let y = e.pageY + 15;

    if (x + rect.width > window.innerWidth) x = e.pageX - rect.width - 15;
    if (y + rect.height > window.innerHeight) y = e.pageY - rect.height - 15;

    preview.style.left = x + 'px';
    preview.style.top = y + 'px';
  }

  link.addEventListener('mouseenter', e => {
    preview.classList.add('show');
    updatePosition(e);
  });

  link.addEventListener('mousemove', e => {
    updatePosition(e);
  });

  link.addEventListener('mouseleave', () => {
    preview.classList.remove('show');
  });
});

// ---------------------- EDITOR LIVE ----------------------
const editor = document.getElementById('editor');
const preview = document.getElementById('preview');

function updatePreview() {
  preview.innerHTML = editor.value;
}

editor.addEventListener('input', updatePreview);
updatePreview();
  const saveBtn = document.getElementById('saveBtn');
const saveStatus = document.getElementById('saveStatus');

// --- CONFIGURA QUI ---
const repoOwner = 'mazaky00';      // tuo username GitHub
const repoName = 'tuo-repo';       // nome del repository
const filePath = 'contenuto.html'; // file che vuoi aggiornare
const branch = 'main';             // branch
const githubToken = 'INSERISCI_IL_TUO_TOKEN_QUI';

// Funzione Save
saveBtn.addEventListener('click', async () => {
  saveStatus.innerText = 'Salvataggio in corso...';

  try {
    // Primo passo: ottieni SHA del file se esiste
    const getRes = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}?ref=${branch}`, {
      headers: { Authorization: `token ${githubToken}` }
    });

    let sha = null;
    if(getRes.status === 200) {
      const data = await getRes.json();
      sha = data.sha;
    }

    // Secondo passo: salva il contenuto
    const content = btoa(unescape(encodeURIComponent(editor.value))); // base64

    const res = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`, {
      method: 'PUT',
      headers: {
        Authorization: `token ${githubToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: 'Aggiornamento dal MiniWiki editor',
        content: content,
        branch: branch,
        sha: sha
      })
    });

    if(res.ok) {
      saveStatus.innerText = '‚úÖ Salvataggio completato!';
    } else {
      const err = await res.json();
      saveStatus.innerText = '‚ùå Errore: ' + err.message;
    }

  } catch(err) {
    saveStatus.innerText = '‚ùå Errore: ' + err.message;
  }
});
</script>

</body>
</html>>
